name: Update OpenClaw Image Hash

on:
  schedule:
    - cron: "0 2 * * 0" # Weekly Sunday 2am UTC (1hr before autoUpgrade)
  workflow_dispatch:

env:
  HASHES_FILE: hosts/system/containers/image-hashes.json
  IMAGE_NAME: ghcr.io/phioranex/openclaw-docker
  IMAGE_TAG: latest

jobs:
  update-hash:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v27
        with:
          github_access_token: ${{ secrets.GITHUB_TOKEN }}
          extra_nix_config: |
            extra-experimental-features = nix-command flakes

      - name: Fetch latest image digest
        id: fetch_digest
        run: |
          set -euo pipefail

          digest=$(docker manifest inspect "$IMAGE_NAME:$IMAGE_TAG" 2>/dev/null | \
            jq -r '.manifests[] | select(.platform.architecture=="arm64" and .platform.os=="linux").digest')

          if [[ -z "$digest" || "$digest" == "null" ]]; then
            echo "::error::Failed to fetch arm64 image digest"
            exit 1
          fi

          echo "digest=$digest" >> $GITHUB_OUTPUT
          echo "Fetched digest: $digest"

      - name: Get current digest from hashes file
        id: current
        run: |
          set -euo pipefail
          current=$(jq -r '.openclaw.imageDigest' "$HASHES_FILE")
          echo "digest=$current" >> $GITHUB_OUTPUT
          echo "Current digest: $current"

      - name: Check if update needed
        id: check
        run: |
          if [[ "${{ steps.current.outputs.digest }}" == "${{ steps.fetch_digest.outputs.digest }}" ]]; then
            echo "No update needed - digests match"
            echo "needs_update=false" >> $GITHUB_OUTPUT
          else
            echo "Update needed - new image available"
            echo "needs_update=true" >> $GITHUB_OUTPUT
          fi

      - name: Fetch Nix sha256
        if: steps.check.outputs.needs_update == 'true'
        id: fetch_sha256
        run: |
          set -euo pipefail

          sha256=$(nix run nixpkgs#nix-prefetch-docker -- \
            --image-name "$IMAGE_NAME" \
            --image-tag "$IMAGE_TAG" \
            --os linux \
            --arch arm64 \
            --quiet 2>/dev/null | tail -1)

          if [[ -z "$sha256" || ! "$sha256" =~ ^[a-zA-Z0-9] ]]; then
            echo "::error::Failed to fetch valid nix sha256"
            exit 1
          fi

          echo "sha256=$sha256" >> $GITHUB_OUTPUT
          echo "Fetched sha256: $sha256"

      - name: Update hashes file
        if: steps.check.outputs.needs_update == 'true'
        run: |
          set -euo pipefail

          jq --arg digest "${{ steps.fetch_digest.outputs.digest }}" \
             --arg sha256 "${{ steps.fetch_sha256.outputs.sha256 }}" \
             '.openclaw.imageDigest = $digest | .openclaw.sha256 = $sha256' \
             "$HASHES_FILE" > "$HASHES_FILE.tmp"

          mv "$HASHES_FILE.tmp" "$HASHES_FILE"

          echo "=== Updated hashes ==="
          jq '.openclaw' "$HASHES_FILE"

      - name: Commit and push
        if: steps.check.outputs.needs_update == 'true'
        run: |
          set -euo pipefail

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add "$HASHES_FILE"
          git commit -m "chore(openclaw): update base image hash

          digest: ${{ steps.fetch_digest.outputs.digest }}
          sha256: ${{ steps.fetch_sha256.outputs.sha256 }}"

          git push
