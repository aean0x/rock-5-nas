#!/usr/bin/env bash
set -euo pipefail
source "$(dirname "$0")/scripts/common.sh"
cd "${REPO_ROOT}"

usage() {
    echo "Usage: $0 <command> [args]"
    echo ""
    echo "${DESC} -- remote management wrapper."
    echo ""
    echo "Commands:"
    echo "  ssh                  Interactive SSH"
    echo "  help                 Show device commands"
    echo ""
    echo "First-time setup:"
    echo "  build-iso            Build bootable ISO image"
    echo "  build-netboot        Build netboot images"
    echo "  netboot              Start PXE server (builds if needed)"
    echo "  install              Remote install (boot ISO/netboot first, then run this)"
    echo ""
    echo "On-device lifecycle (runs on the device; may be slow on low-RAM SBCs):"
    echo "  switch               Fetch latest config, rebuild, activate now"
    echo "  upgrade              Same as switch + update nixpkgs/flake inputs"
    echo "  boot                 Fetch latest config, rebuild, activate on reboot"
    echo "  try                  Fetch latest config, rebuild, activate temporarily"
    echo "  rollback             Roll back to previous system generation"
    echo "  cleanup              Garbage collect and optimize store"
    echo "  build-log            View last build log"
    echo "  system-info          Show system status and disk usage"
    echo ""
    echo "Services:"
    echo "  oc <cmd> [args]      OpenClaw CLI (oc wizard, oc gateway status, ...)"
    echo "  onedrive-sync        Trigger OneDrive sync now"
    echo ""
    echo "Troubleshooting:"
    echo "  docker-ps            List containers"
    echo "  docker-stats         One-shot resource snapshot"
    echo "  logs <container>     Tail container logs"
    echo "  journal [unit]       Tail system logs"
    echo ""
    echo "Container exec:"
    echo "  <container> [cmd]    Shell into container, or run a command"
    echo "                       Use 'docker-ps' to see running containers"
    echo ""
    echo "Workstation remote-build (recommended for low-memory devices):"
    echo "  remote-switch        Build on workstation, push closure, activate now"
    echo "  remote-upgrade       Update flake inputs, build, push, activate now"
    echo "  remote-boot          Build on workstation, push, activate on reboot"
    echo "  remote-try           Build on workstation, push, activate temporarily"
    echo "  remote-dry           Build on workstation, dry run (no activation)"
    echo "  remote-build         Build on workstation only (no push)"
    exit 1
}

[[ $# -lt 1 ]] && usage

CMD="$1"
shift

case "$CMD" in
    -h|--help)
        usage
        ;;

    ssh)
        check_ssh
        exec ssh ${SSH_OPTS} "$TARGET"
        ;;

    help)
        check_ssh
        ssh -tt ${SSH_OPTS} "$TARGET" "help"
        ;;

    onedrive-sync)
        check_ssh
        info "Triggering OneDrive sync..."
        ssh -t ${SSH_OPTS} "$TARGET" "sudo systemctl start onedrive-sync.service && sudo journalctl -u onedrive-sync.service -n 20 --no-pager"
        ;;

    # On-device commands (forwarded via SSH)
    switch|upgrade|boot|try|rollback|cleanup|build-log|system-info|\
    docker-ps|docker-stats|docker-restart|logs|journal)
        check_ssh
        ssh -tt ${SSH_OPTS} "$TARGET" "$CMD" "$@"
        ;;

    # First-time setup (delegated to scripts/)
    build-iso)
        exec "${REPO_ROOT}/scripts/build-iso.sh"
        ;;

    build-netboot)
        exec "${REPO_ROOT}/scripts/build-netboot.sh"
        ;;

    netboot)
        exec "${REPO_ROOT}/scripts/netboot.sh"
        ;;

    install)
        exec "${REPO_ROOT}/scripts/install.sh"
        ;;

    # Workstation build+deploy modes
    remote-switch|remote-upgrade|remote-boot|remote-try|remote-dry|remote-build)
        check_aarch64_support
        check_ssh

        ACTION="${CMD#remote-}"

        # Update flake inputs first if upgrading
        if [[ "$ACTION" == "upgrade" ]]; then
            update_flake
            ACTION="switch"
        fi

        case "$ACTION" in
            switch|boot|build) ;;
            try)  ACTION="test" ;;
            dry)  ACTION="dry-activate" ;;
            *)    usage ;;
        esac

        build_system
        deploy_system "$ACTION"
        ;;

    # Catch-all: forward to device (container exec, etc.)
    *)
        check_ssh
        ssh -tt ${SSH_OPTS} "$TARGET" "$CMD" "$@"
        ;;
esac
